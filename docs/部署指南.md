# MSHD系统部署指南

## 目录
1. [环境准备](#环境准备)
2. [数据库部署](#数据库部署)
3. [后端部署](#后端部署)
4. [前端部署](#前端部署)
5. [Nginx配置](#nginx配置)
6. [常见问题](#常见问题)

## 环境准备

### 系统要求
- 操作系统：Linux (Ubuntu 20.04+/CentOS 7+) 或 Windows Server
- CPU：2核心及以上
- 内存：4GB及以上
- 磁盘：50GB及以上

### 软件要求
- JDK 17+
- Node.js 18+
- MySQL 8.0+
- Redis 6.0+（可选）
- Nginx 1.18+（可选）

## 数据库部署

### 1. 安装MySQL

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install mysql-server
sudo mysql_secure_installation
```

**CentOS/RHEL:**
```bash
sudo yum install mysql-server
sudo systemctl start mysqld
sudo systemctl enable mysqld
```

### 2. 创建数据库和用户

```sql
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE mshd DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户并授权
CREATE USER 'mshd'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON mshd.* TO 'mshd'@'localhost';
FLUSH PRIVILEGES;
```

### 3. 导入初始化脚本

```bash
mysql -u mshd -p mshd < database/init.sql
```

### 4. 验证数据库

```sql
USE mshd;
SHOW TABLES;
SELECT COUNT(*) FROM disaster_data;
```

## 后端部署

### 方式一：使用Maven打包部署

#### 1. 配置文件修改

编辑 `mshd-backend/src/main/resources/application.yml`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/mshd?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: mshd
    password: your_password

  data:
    mongodb:
      host: localhost
      port: 27017
      database: mshd_media
      # 如果MongoDB需要认证，取消注释
      # username: mshd
      # password: your_password

    redis:
      host: localhost
      port: 6379
      password: # Redis密码，如果没有设置则留空

file:
  upload-dir: /var/mshd/uploads  # 修改为生产环境路径

jwt:
  secret: your-production-secret-key-change-this  # 修改为安全的密钥
```

#### 2. 打包应用

```bash
cd mshd-backend
mvn clean package -DskipTests
```

打包完成后，在 `target` 目录下会生成 `mshd-backend-1.0.0.jar`

#### 3. 运行应用

```bash
# 创建应用目录
sudo mkdir -p /opt/mshd
sudo cp target/mshd-backend-1.0.0.jar /opt/mshd/

# 运行应用
cd /opt/mshd
java -jar mshd-backend-1.0.0.jar

# 后台运行
nohup java -jar mshd-backend-1.0.0.jar > mshd.log 2>&1 &

# 查看日志
tail -f mshd.log
```

#### 4. 配置为系统服务（推荐）

创建systemd服务文件 `/etc/systemd/system/mshd.service`：

```ini
[Unit]
Description=MSHD Backend Service
After=network.target mysql.service

[Service]
Type=simple
User=mshd
WorkingDirectory=/opt/mshd
ExecStart=/usr/bin/java -jar /opt/mshd/mshd-backend-1.0.0.jar
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
# 创建运行用户
sudo useradd -r -s /bin/false mshd
sudo chown -R mshd:mshd /opt/mshd

# 启动服务
sudo systemctl daemon-reload
sudo systemctl start mshd
sudo systemctl enable mshd

# 查看状态
sudo systemctl status mshd

# 查看日志
sudo journalctl -u mshd -f
```

### 方式二：使用Docker部署

创建 `Dockerfile`：

```dockerfile
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/mshd-backend-1.0.0.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

构建和运行：

```bash
# 构建镜像
docker build -t mshd-backend:1.0.0 .

# 运行容器
docker run -d \
  --name mshd-backend \
  -p 8080:8080 \
  -v /var/mshd/uploads:/app/uploads \
  -e SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3306/mshd \
  -e SPRING_DATASOURCE_USERNAME=mshd \
  -e SPRING_DATASOURCE_PASSWORD=your_password \
  mshd-backend:1.0.0
```

## 前端部署

### 1. 构建生产版本

```bash
cd mshd-frontend

# 安装依赖
npm install

# 构建
npm run build
```

构建完成后，在 `dist` 目录下会生成静态文件。

### 2. 部署到Web服务器

#### 方式一：使用Nginx部署

```bash
# 复制构建文件到Nginx目录
sudo mkdir -p /var/www/mshd
sudo cp -r dist/* /var/www/mshd/
```

创建Nginx配置文件 `/etc/nginx/sites-available/mshd`：

```nginx
server {
    listen 80;
    server_name mshd.yourdomain.com;  # 修改为你的域名

    root /var/www/mshd;
    index index.html;

    # 前端路由
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

启用配置并重启Nginx：

```bash
sudo ln -s /etc/nginx/sites-available/mshd /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

#### 方式二：使用Apache部署

创建Apache配置文件 `/etc/apache2/sites-available/mshd.conf`：

```apache
<VirtualHost *:80>
    ServerName mshd.yourdomain.com
    DocumentRoot /var/www/mshd

    <Directory /var/www/mshd>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # 支持前端路由
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # API代理
    ProxyPass /api http://localhost:8080/api
    ProxyPassReverse /api http://localhost:8080/api

    ErrorLog ${APACHE_LOG_DIR}/mshd-error.log
    CustomLog ${APACHE_LOG_DIR}/mshd-access.log combined
</VirtualHost>
```

启用配置：

```bash
sudo a2enmod rewrite proxy proxy_http
sudo a2ensite mshd
sudo systemctl restart apache2
```

## HTTPS配置（推荐）

### 使用Let's Encrypt免费证书

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书并自动配置Nginx
sudo certbot --nginx -d mshd.yourdomain.com

# 测试自动续期
sudo certbot renew --dry-run
```

Nginx配置会自动更新为HTTPS。

## 性能优化

### 1. JVM参数优化

编辑systemd服务文件，添加JVM参数：

```ini
[Service]
ExecStart=/usr/bin/java -Xms1g -Xmx2g -XX:+UseG1GC -jar /opt/mshd/mshd-backend-1.0.0.jar
```

### 2. 数据库优化

编辑MySQL配置 `/etc/mysql/my.cnf`：

```ini
[mysqld]
max_connections = 200
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
```

### 3. 启用Redis缓存

确保Redis已安装并运行：

```bash
sudo systemctl start redis
sudo systemctl enable redis
```

## 监控和日志

### 1. 应用日志

```bash
# 实时查看应用日志
sudo journalctl -u mshd -f

# 查看最近100行
sudo journalctl -u mshd -n 100

# 查看今天的日志
sudo journalctl -u mshd --since today
```

### 2. Nginx访问日志

```bash
# 实时查看访问日志
tail -f /var/log/nginx/access.log

# 统计访问量
cat /var/log/nginx/access.log | wc -l
```

### 3. 系统资源监控

```bash
# 查看CPU和内存使用
top

# 查看Java进程资源使用
ps aux | grep java

# 查看磁盘使用
df -h
```

## 备份策略

### 1. 数据库备份

创建备份脚本 `/opt/mshd/backup.sh`：

```bash
#!/bin/bash
BACKUP_DIR="/backup/mshd"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="mshd"
MYSQL_PASSWORD="your_password"

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u$MYSQL_USER -p$MYSQL_PASSWORD mshd > $BACKUP_DIR/mshd_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/mshd_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: mshd_$DATE.sql.gz"
```

添加到crontab（每天凌晨2点执行）：

```bash
chmod +x /opt/mshd/backup.sh
crontab -e
# 添加：
0 2 * * * /opt/mshd/backup.sh
```

### 2. 文件备份

```bash
# 备份上传文件
tar -czf /backup/mshd/uploads_$(date +%Y%m%d).tar.gz /var/mshd/uploads/
```

## 常见问题

### 1. 端口冲突

如果8080端口被占用：

```bash
# 查看端口占用
sudo lsof -i :8080

# 修改application.yml中的端口
server:
  port: 8081
```

### 2. 内存不足

如果出现OutOfMemoryError：

```bash
# 增加JVM堆内存
java -Xms2g -Xmx4g -jar mshd-backend-1.0.0.jar
```

### 3. 数据库连接失败

检查MySQL服务状态：

```bash
sudo systemctl status mysql

# 检查MySQL是否监听
sudo netstat -tlnp | grep 3306

# 测试连接
mysql -u mshd -p -h localhost
```

### 4. 跨域问题

如果前后端不在同一域名，需要配置CORS：

```java
// 在后端添加配置类
@Configuration
public class CorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        CorsConfiguration config = new CorsConfiguration();
        config.addAllowedOrigin("http://yourdomain.com");
        config.addAllowedHeader("*");
        config.addAllowedMethod("*");
        source.registerCorsConfiguration("/**", config);
        return new CorsFilter(source);
    }
}
```

## 安全建议

1. **修改默认密码** - 修改数据库和应用的默认密码
2. **启用防火墙** - 只开放必要的端口（80, 443, 22）
3. **定期更新** - 及时更新系统和依赖包
4. **使用HTTPS** - 生产环境务必启用HTTPS
5. **备份数据** - 定期备份数据库和文件
6. **监控日志** - 定期检查应用和系统日志

## 升级指南

### 1. 备份当前版本

```bash
# 备份数据库
mysqldump -u mshd -p mshd > mshd_backup_before_upgrade.sql

# 备份应用
cp /opt/mshd/mshd-backend-1.0.0.jar /opt/mshd/mshd-backend-1.0.0.jar.bak
```

### 2. 部署新版本

```bash
# 停止服务
sudo systemctl stop mshd

# 复制新版本
sudo cp mshd-backend-1.1.0.jar /opt/mshd/

# 更新systemd配置（如果需要）
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start mshd

# 检查状态
sudo systemctl status mshd
```

### 3. 回滚（如果需要）

```bash
sudo systemctl stop mshd
sudo cp /opt/mshd/mshd-backend-1.0.0.jar.bak /opt/mshd/mshd-backend-1.0.0.jar
sudo systemctl start mshd
```

---

部署完成后，访问 `http://your-domain.com` 即可使用系统！
